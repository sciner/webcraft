# Чтение схематик

## Исходники

Классы, существовавшие до 06.2023:
- `server/plugins/char_worldedit.ts` - реализует команды чата для работы со схематиками
- `server/plugins/worldedit/schematic_reader.ts` - реализует высокоуровневую логику чтения схематики. Преобразует блоки в формат madcraft, подготавливает их ко вставке в мир.
- `server/plugins/worldedit/worker.ts`

Классы, добавленные 06.2023:
- `server/plugins/worldedit/file_buffer.ts` - предоставляет случайный доступ к упакованныму gzip файлу, загружая его в память или при необходимости распаковывая во временный файл.
- `server/plugins/worldedit/binary_schematic.ts` - читает схематику в двоичном формате с малыми дополнительными затратами памяти, парсит NBT, возвращает блоки из указанного AABB. Является заменой модуля prismarine-nbt. Но наверное поддерживает меньше форматов, поэтому имеет опцию читать через prismarine-nbt (по-старому).
- `server/plugins/worldedit/schematic_job.ts` - управляет процессом вставки схематики в мир (только новым способом, не через буфер обмена).

## Команды

Все как было до 06.2023, кроме:
- добавлена необязательная команда `/schem info` - выводит информацию о загруженной схематике

### Автоматическое возобновление

Если до закрытия мира была незвершенная вставка схематики, она автоматически возобновится через 20 секунд после открытия мира. После ее завершения, схематика будет автомтатически выгружена из памяти.


### Ограничения на выполнение команд

Команды работы со схематикой выглядят как будто используется clipboard. Но на самом деле он не используется.

В мире может быть одновременно загруженна максимум 1 схематика.

Пользователь, который ее загрузил, может ее отменить, но не может пользоваться в это время некоторыми clipboard (т.к. создается видимость, что в clipboard находится схематика).

Другие пользователи во время вставки могут работать с clipboard как обычно, но не могут работать со схематиками.

Если сейчас воркер выполняет команду связанную со схематикой, большинство команд отказываются выполнятся и выводят об этом сообщение. Нужно дождаться завершения предыдущей команды и повторить попытку. Обоснование такого решения: если бы команды складировались в очередь, а потом все выполнялись, легко было бы по ошибке создать огромный объем работы или нарушить последовательность действий.

## Детали реализации

Если распаковыанный размер превышает `DEFAULT_MAX_MEMORY_FILE_SIZE` = 50 MB, то схематика частично распаковывается (распаковывается gzip, но не varInt массив блоков) во временный файл в папке со схематиками и читается оттуда частями.

В процессе вставки, varInt блоки распаковываются и передается из воркера в основной поток частями. `SchematicJob` следит, чтобы не число гразных блоков и общее число чанков в памяти не превышало константы `MAX_DIRTY_BLOCKS` и `MAX_CHUNK_ACTORS` в файле `server/plugins/worldedit/schematic_job.ts`. Когда превышает - запрос новых чанков схематики из воркера приостанавливается пока ресурсы снова не освободятся.

Если сервер упадет до завершения вставки, описание задачи и ее прогресс останется в БД - в поле state таблицы world, поле JSON schematicJob. Ее можно вручную возобновить после перезапуска. Но автоматически она не запускается при старте мира (чтобы избежать возможных циклических падений).

## TODO

Не моделировать воду в чанках сематики до завершении вставки.
Удалять воду при вставке воздуха или других блоков без воды.