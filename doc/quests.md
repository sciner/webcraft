# Квесты

Код логики квестов - в папке `node_server/quest`
Код чтения и кеширование квестов из БД - в `node_server/db/world/quest.ts`

## Описание квестов, не связанное с пользователем

Хранится в БД. Создается в DBWorldMigration во время создания БД. Целиком читается в память при старте мира. Для изменения квестов нужно создать миграцию и новую версию БД.

Таблицы:

`quest_group` - пока всего 2 группы. Похоже, влияет только на отображение квеста, не на логику выполнения.

`quest` - каждая строка описывает квест. Некоторые важные поля:
- `quest.is_default` - если 1, то этот квест автоматически стартует у игрока при регистрации
- `quest.next_quests` - id квестов, которые стартуют после его завершения

`quest_action` - каждая строка описывает один шаг одного квеста.
Квест содержит 1 или более действий, которые должен выполнить игрок. Они не упорядочены. Подробнее - в разделе ниже.

`quest_action_type` - словарь типов действий квестов. Между строками этой таблицы и подклассами `QuestActionBase` соответствие 1:1.

`quest_reward` - каждая строка описывает один приз за окончание одного квеста. Пока призом может быть только выдача заданного числа определенного типа блока. У квеста может быть любое число призов.

### Действия квеста

У каждого действия нужно указать:
- `quest_action.id`
- `quest_action.quest_id`
- `quest_action.quest_action_type_id`
- `quest_action.params` - параметры действия в виде JSON

Для действий типа "Добыть", "Скрафтить", "Установить блок" используюся следующие параметры:
- `block_id?: int` - id блока, который нужно найти/скрафтить/установить и т.п.
- `block_suffixes?: string[]` - массив суффиксов имен блоков (начинающихся на _, например, "_LOG"), которые нужно найти/скрафтить/установить и т.п.
- `cnt: int` число блоков, которые нужно найти/скрафтить/установить и т.п.
Зачтутся любые блоки, у которых совпадает `block_id` или их имя оканчивается на одну из строк в `block_suffixes`.

Действия типов "Использовать инструмент" и "Достигнуть координат" пока не используются и неизвестно, работают ли.

Для совместимости со старыми версиями, некоторые параметры также дублируются отдельными полями: `block_id`, `cnt`, `pos`. Их можно не заполнять в новых квестах - это не важно.

### Примеры добавления квеста

См. добавление квестов в миграции версии 103 в файле `db/world/migrations.ts`. Более ранние миграции лучше не использовать как примеры, т.к. там данные действий сохранялись не в `quest_action.params`, а в отдельные поля.

Для вставки одинарной кавычки в строки, нужно писать ее 2 раза подряд.

## Квесты пользователя

Прогресс квестов (и состояние каждого действия в них в виде JSON) хранится в таблице `user_quest`. Лучшее ее вручную не менять, это трудно сделать правильно, может привести к некорректному состоянию.

Если удалить оттуда все записи для одного пользователя, туда автоматически добавляются квесты с `quest.is_default` == 1.

## TODO

Было бы удобно перенести весь конфиг квестов в JSON, чтобы его можно было редактировать без миграций и SQL.